(function(){function Cache(maxSize,debug,storage){this.maxSize_=maxSize||-1;this.debug_=debug||false;this.storage_=storage||new Cache.BasicCacheStorage;this.fillFactor_=.75;this.stats_={};this.stats_["hits"]=0;this.stats_["misses"]=0;this.log_("Initialized cache with size "+maxSize)}Cache.Priority={LOW:1,NORMAL:2,HIGH:4};Cache.BasicCacheStorage=function(){this.items_={};this.count_=0};Cache.BasicCacheStorage.prototype.get=function(key){return this.items_[key]};Cache.BasicCacheStorage.prototype.set=function(key,value){if(typeof this.get(key)==="undefined")this.count_++;this.items_[key]=value};Cache.BasicCacheStorage.prototype.size=function(key,value){return this.count_};Cache.BasicCacheStorage.prototype.remove=function(key){var item=this.get(key);if(typeof item!=="undefined")this.count_--;delete this.items_[key];return item};Cache.BasicCacheStorage.prototype.keys=function(){var ret=[],p;for(p in this.items_)ret.push(p);return ret};Cache.LocalStorageCacheStorage=function(namespace){this.prefix_="cache-storage."+(namespace||"default")+".";var escapedPrefix=this.prefix_.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");this.regexp_=new RegExp("^"+escapedPrefix)};Cache.LocalStorageCacheStorage.prototype.get=function(key){var item=window.localStorage[this.prefix_+key];if(item)return JSON.parse(item);return null};Cache.LocalStorageCacheStorage.prototype.set=function(key,value){window.localStorage[this.prefix_+key]=JSON.stringify(value)};Cache.LocalStorageCacheStorage.prototype.size=function(key,value){return this.keys().length};Cache.LocalStorageCacheStorage.prototype.remove=function(key){var item=this.get(key);delete window.localStorage[this.prefix_+key];return item};Cache.LocalStorageCacheStorage.prototype.keys=function(){var ret=[],p;for(p in window.localStorage){if(p.match(this.regexp_))ret.push(p.replace(this.prefix_,""))}return ret};Cache.prototype.getItem=function(key){var item=this.storage_.get(key);if(item!=null){if(!this.isExpired_(item)){item.lastAccessed=(new Date).getTime()}else{this.removeItem(key);item=null}}var returnVal=item?item.value:null;if(returnVal){this.stats_["hits"]++;this.log_("Cache HIT for key "+key)}else{this.stats_["misses"]++;this.log_("Cache MISS for key "+key)}return returnVal};Cache._CacheItem=function(k,v,o){if(!k){throw new Error("key cannot be null or empty")}this.key=k;this.value=v;o=o||{};if(o.expirationAbsolute){o.expirationAbsolute=o.expirationAbsolute.getTime()}if(!o.priority){o.priority=Cache.Priority.NORMAL}this.options=o;this.lastAccessed=(new Date).getTime()};Cache.prototype.setItem=function(key,value,options){if(this.storage_.get(key)!=null){this.removeItem(key)}this.addItem_(new Cache._CacheItem(key,value,options));this.log_("Setting key "+key);if(this.maxSize_>0&&this.size()>this.maxSize_){var that=this;setTimeout(function(){that.purge_.call(that)},0)}};Cache.prototype.clear=function(){var keys=this.storage_.keys();for(var i=0;i<keys.length;i++){this.removeItem(keys[i])}this.log_("Cache cleared")};Cache.prototype.getStats=function(){return this.stats_};Cache.prototype.toHtmlString=function(){var returnStr=this.size()+" item(s) in cache<br /><ul>";var keys=this.storage_.keys();for(var i=0;i<keys.length;i++){var item=this.storage_.get(keys[i]);returnStr=returnStr+"<li>"+item.key.toString()+" = "+item.value.toString()+"</li>"}returnStr=returnStr+"</ul>";return returnStr};Cache.prototype.resize=function(newMaxSize){this.log_("Resizing Cache from "+this.maxSize_+" to "+newMaxSize);var oldMaxSize=this.maxSize_;this.maxSize_=newMaxSize;if(newMaxSize>0&&(oldMaxSize<0||newMaxSize<oldMaxSize)){if(this.size()>newMaxSize){this.purge_()}}this.log_("Resizing done")};Cache.prototype.purge_=function(){var tmparray=new Array;var purgeSize=Math.round(this.maxSize_*this.fillFactor_);if(this.maxSize_<0)purgeSize=this.size()*this.fillFactor_;var keys=this.storage_.keys();for(var i=0;i<keys.length;i++){var key=keys[i];var item=this.storage_.get(key);if(this.isExpired_(item)){this.removeItem(key)}else{tmparray.push(item)}}if(tmparray.length>purgeSize){tmparray=tmparray.sort(function(a,b){if(a.options.priority!=b.options.priority){return b.options.priority-a.options.priority}else{return b.lastAccessed-a.lastAccessed}});while(tmparray.length>purgeSize){var ritem=tmparray.pop();this.removeItem(ritem.key)}}this.log_("Purged cached")};Cache.prototype.addItem_=function(item,attemptedAlready){var cache=this;try{this.storage_.set(item.key,item)}catch(err){if(attemptedAlready){this.log_("Failed setting again, giving up: "+err.toString());throw err}this.log_("Error adding item, purging and trying again: "+err.toString());this.purge_();this.addItem_(item,true)}};Cache.prototype.removeItem=function(key){var item=this.storage_.remove(key);this.log_("removed key "+key);if(item&&item.options&&item.options.callback){setTimeout(function(){item.options.callback.call(null,item.key,item.value)},0)}return item?item.value:null};Cache.prototype.removeWhere=function(test){var keys=this.storage_.keys();for(var i=0;i<keys.length;i++){var key=keys[i];var item=this.storage_.get(key);if(test(key,item.value)===true){this.removeItem(key)}}};Cache.prototype.size=function(){return this.storage_.size()};Cache.prototype.isExpired_=function(item){var now=(new Date).getTime();var expired=false;if(item.options.expirationAbsolute&&item.options.expirationAbsolute<now){expired=true}if(!expired&&item.options.expirationSliding){var lastAccess=item.lastAccessed+item.options.expirationSliding*1e3;if(lastAccess<now){expired=true}}return expired};Cache.prototype.log_=function(msg){if(this.debug_){console.log(msg)}};var root=this;if(typeof module!=="undefined"&&module.exports){module.exports=Cache}else if(typeof define=="function"&&define.amd){define(function(){return Cache})}else{root.Cache=Cache}})();